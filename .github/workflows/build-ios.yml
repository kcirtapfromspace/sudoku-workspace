name: Build iOS App

on:
  push:
    branches: [main]
    paths:
      - 'ios/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ios/**'
  workflow_dispatch:
    inputs:
      deploy_testflight:
        description: 'Deploy to TestFlight'
        required: false
        default: false
        type: boolean

env:
  SCHEME: Sudoku
  PROJECT_PATH: ios/Sudoku/Sudoku.xcodeproj
  BUNDLE_ID: com.sudoku.app

jobs:
  # Build and test on PRs
  build:
    name: Build & Test
    runs-on: macos-14
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ios/Sudoku

    steps:
      - uses: actions/checkout@v4

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ios/Sudoku/build/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('ios/Sudoku/**/*.swift', 'ios/Sudoku/**/*.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('ios/Sudoku/Sudoku.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | tail -1)
          echo "Using Xcode at: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Build for testing
        run: |
          SIMULATOR_NAME=$(xcrun simctl list devices available | grep -m 1 "iPhone" | sed -E 's/^[[:space:]]+([^(]+).*/\1/' | xargs)
          echo "Using simulator: $SIMULATOR_NAME"

          xcodebuild build \
            -project Sudoku.xcodeproj \
            -scheme $SCHEME \
            -destination "platform=iOS Simulator,name=$SIMULATOR_NAME" \
            -configuration Debug \
            -derivedDataPath ./build/DerivedData \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu) \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee build.log

  # Deploy to TestFlight on main branch pushes
  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-14
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && inputs.deploy_testflight)
    defaults:
      run:
        working-directory: ios/Sudoku

    steps:
      - uses: actions/checkout@v4

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ios/Sudoku/build/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('ios/Sudoku/**/*.swift', 'ios/Sudoku/**/*.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('ios/Sudoku/Sudoku.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | tail -1)
          echo "Using Xcode at: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios/Sudoku

      - name: Create App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p fastlane
          echo -n "$API_KEY_BASE64" | base64 --decode > fastlane/AuthKey.p8
          chmod 600 fastlane/AuthKey.p8

      - name: Install signing certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          security find-identity -v -p codesigning $KEYCHAIN_PATH

      - name: Install provisioning profile
        id: install-profile
        env:
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          PP_CONTENT=$(/usr/bin/security cms -D -i $PP_PATH)
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$PP_CONTENT")
          PP_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" /dev/stdin <<< "$PP_CONTENT")

          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PP_UUID.mobileprovision

          echo "Installed provisioning profile: $PP_NAME (UUID: $PP_UUID)"
          echo "PP_UUID=$PP_UUID" >> $GITHUB_OUTPUT
          echo "PP_NAME=$PP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_FILEPATH: ./fastlane/AuthKey.p8
          APPLE_PROVISIONING_PROFILE_NAME: ${{ steps.install-profile.outputs.PP_NAME }}
          APPLE_PROVISIONING_PROFILE_UUID: ${{ steps.install-profile.outputs.PP_UUID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 5
        run: |
          bundle exec fastlane beta_manual \
            changelog:"Automated build from CI"

      - name: Clean up
        if: always()
        run: |
          rm -f fastlane/AuthKey.p8 || true
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/* || true
